// Example configuration bootstrap. Copy this file to `config.js` and adjust any
// defaults locally; keep `config.js` out of version control.
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const CONFIG_FILE = path.join(__dirname, 'config.json');

const defaultSillyTavernConfig = {
    enabled: false,
    baseUrl: '',
    importEndpoint: '/api/content/importURL',
    csrfToken: '',
    sessionCookie: '',
    extraHeaders: {}
};

const defaultMeilisearchConfig = {
    enabled: false,
    host: 'http://127.0.0.1:7700',
    apiKey: '',
    indexName: 'cards'
};

const defaultVectorSearchConfig = {
    enabled: false,
    cardsIndex: 'cards_vsem',
    chunksIndex: 'card_chunks',
    embedModel: 'snowflake-arctic-embed2:latest',
    embedderName: 'arctic2-1024',
    embedDimensions: 1024,
    ollamaUrl: 'http://127.0.0.1:11434',
    semanticRatio: 0.4,
    cardsMultiplier: 2,
    maxCardHits: 200,
    chunkLimit: 60,
    chunkWeight: 0.6,
    rrfK: 60
};

const defaultCtSyncConfig = {
    enabled: false,
    intervalMinutes: 180,
    pages: 3,
    hitsPerPage: 49,
    minTokens: 300,
    maxTokens: 900000,
    bannedTags: [],
    excludedWarnings: [],
    bearerToken: '',
    cfClearance: '',
    session: '',
    allowedWarnings: ''
};

const defaultCharacterArchitectConfig = {
    enabled: false,
    url: 'http://localhost:3456'
};

// Default configuration
const defaultConfig = {
    autoUpdateInterval: 60,
    autoUpdateMode: false,
    syncTagsMode: true,
    backupMode: false,
    port: 6969,
    ip: "127.0.0.1",
    venus: false,
    syncLimit: 500,
    pageLimit: 1,
    startPage: 1,
    cycle_topics: false,
    topic: "",
    excludeTopic: "",
    use_timeline: false,
    min_tokens: 0,
    apikey: "",
    chubProfileName: '',
    followedCreators: [],
    syncFollowedCreators: false,
    followedCreatorsOnly: false,
    publicBaseUrl: '',
    sillyTavern: defaultSillyTavernConfig,
    meilisearch: defaultMeilisearchConfig,
    vectorSearch: defaultVectorSearchConfig,
    ctSync: defaultCtSyncConfig,
    characterArchitect: defaultCharacterArchitectConfig
};

/**
 * Load configuration from file or create default
 */
export function loadConfig() {
    if (!fs.existsSync(CONFIG_FILE)) {
        fs.writeFileSync(CONFIG_FILE, JSON.stringify(defaultConfig, null, 4));
        console.log('[INFO] Created default config.json');
        return defaultConfig;
    }

    try {
        const data = fs.readFileSync(CONFIG_FILE, 'utf8');
        const config = JSON.parse(data);

        // Merge with defaults to add any missing keys
        const mergedConfig = { ...defaultConfig, ...config };
        mergedConfig.sillyTavern = {
            ...defaultSillyTavernConfig,
            ...(config.sillyTavern || {})
        };
        mergedConfig.meilisearch = {
            ...defaultMeilisearchConfig,
            ...(config.meilisearch || {})
        };
        mergedConfig.ctSync = {
            ...defaultCtSyncConfig,
            ...(config.ctSync || {})
        };
        mergedConfig.vectorSearch = {
            ...defaultVectorSearchConfig,
            ...(config.vectorSearch || {})
        };
        
        // Normalize followed creators
        if (typeof mergedConfig.followedCreators === 'string') {
            mergedConfig.followedCreators = mergedConfig.followedCreators
                .split(',')
                .map(c => c.trim())
                .filter(c => c);
        }
        
        return mergedConfig;
    } catch (error) {
        console.error('[ERROR] Failed to load config:', error.message);
        return defaultConfig;
    }
}

/**
 * Save configuration to file
 */
export function saveConfig(config) {
    try {
        // Normalize followed creators before saving
        if (Array.isArray(config.followedCreators)) {
            config.followedCreators = config.followedCreators.filter(c => c && c.trim());
        }
        if (typeof config.chubProfileName === 'string') {
            config.chubProfileName = config.chubProfileName.trim();
        }

        const mergedSilly = {
            ...defaultSillyTavernConfig,
            ...(config.sillyTavern || {})
        };
        config.sillyTavern = mergedSilly;

        const mergedMeili = {
            ...defaultMeilisearchConfig,
            ...(config.meilisearch || {})
        };
        config.meilisearch = mergedMeili;

        const mergedCtSync = {
            ...defaultCtSyncConfig,
            ...(config.ctSync || {})
        };
        config.ctSync = mergedCtSync;

        const mergedVectorSearch = {
            ...defaultVectorSearchConfig,
            ...(config.vectorSearch || {})
        };
        config.vectorSearch = mergedVectorSearch;

        const mergedCharacterArchitect = {
            ...defaultCharacterArchitectConfig,
            ...(config.characterArchitect || {})
        };
        config.characterArchitect = mergedCharacterArchitect;

        fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 4));
        console.log('[INFO] Configuration saved');
        return true;
    } catch (error) {
        console.error('[ERROR] Failed to save config:', error.message);
        return false;
    }
}

export default {
    loadConfig,
    saveConfig
};

